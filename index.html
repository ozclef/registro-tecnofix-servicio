

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TechnoFix — Formulario y Ticket</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root{ --accent:#8a2be2; --muted:#666; }
    body{font-family:Inter, Arial, sans-serif; margin:0; background:#f3f4f6; color:#111}
    .app{max-width:1100px; margin:26px auto; padding:18px}
    header{display:flex; justify-content:space-between; align-items:center; gap:12px}
    header h1{margin:0;font-size:20px}
    .layout{display:grid; grid-template-columns:1fr 360px; gap:20px; margin-top:18px}

    /* Form (left) */
    form.card{background:#fff; padding:16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    label{display:block; margin-top:10px; font-weight:600; font-size:13px}
    input[type=text], input[type=tel], input[type=date], select, textarea{width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-top:6px; box-sizing:border-box}
    textarea{min-height:80px}
    .row{display:flex; gap:10px}
    .small{font-size:12px; color:var(--muted)}

    /* Right: ticket preview */
    .preview{background:#fff; padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    .ticket{width:280px; margin:0 auto; font-family: 'Courier New', monospace; font-size:13px; white-space:pre-wrap; line-height:1.3; border:1px dashed #ccc; padding:12px; background:#fff}
    .ticket .center{text-align:center}
    .controls{display:flex; gap:8px; margin-top:12px}
    button{background:var(--accent); color:#fff; border:0; padding:10px 12px; border-radius:8px; cursor:pointer}
    .btn-ghost{background:transparent; border:1px solid var(--accent); color:var(--accent)}

    /* responsive */
    @media (max-width:900px){
      .layout{grid-template-columns:1fr;}
      .preview{order:2}
      form.card{order:1}
      .ticket{margin-top:12px}
    }

    /* print only ticket */
    @media print{ body *{visibility:hidden} .ticket, .ticket *{visibility:visible} .ticket{position:fixed; left:0; top:0; margin:0} }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>TechnoFix / BIO-US — Formulario de Servicio</h1>
        <div class="small">Servicio por: Oscar — Tlaxcala, Tlaxcala</div>
      </div>
      <div>
        <div class="small">Tip: completa los campos para ver la vista previa del ticket en tiempo real.</div>
      </div>
    </header>

    <div class="layout">
      <!-- Form -->
      <form id="serviceForm" class="card" onsubmit="return false;">
        <label>Folio (auto)</label>
        <input id="folioInput" type="text" readonly />

        <div class="row">
          <div style="flex:1">
            <label>Cliente (nombre)</label>
            <input id="clienteInput" type="text" placeholder="Nombre completo" />
          </div>
          <div style="width:160px">
            <label>Tel / Email</label>
            <input id="contactoInput" type="text" placeholder="55-xxxx or mail@ej.com" />
          </div>
        </div>

        <label>Tipo dispositivo</label>
        <select id="tipoInput">
          <option value="Celular">Celular</option>
          <option value="Tablet">Tablet</option>
          <option value="Laptop">Laptop</option>
          <option value="PC">PC Escritorio</option>
        </select>

        <label>Marca</label>
        <select id="marcaInput" onchange="rellenarModelos()">
          <option value="iPhone">iPhone</option>
          <option value="Samsung">Samsung</option>
          <option value="Oppo">Oppo</option>
          <option value="Xiaomi">Xiaomi</option>
          <option value="Otro">Otro</option>
        </select>

        <label>Modelo</label>
        <select id="modeloInput"></select>

        <div class="row">
          <div style="flex:1">
            <label>Fecha (ingreso)</label>
            <input id="fechaInput" type="date" />
          </div>
          <div style="width:140px">
            <label>Hora</label>
            <input id="horaInput" type="text" placeholder="HH:MM" />
          </div>
        </div>

        <label>Origen del daño</label>
        <select id="origenInput">
          <option value="Caída">Caída</option>
          <option value="Golpe">Golpe</option>
          <option value="Agua">Daño por líquidos</option>
          <option value="Uso">Uso / desgaste</option>
          <option value="Desconocido">Desconocido</option>
        </select>

        <label>Descripción del problema (breve)</label>
        <textarea id="problemaInput" placeholder="Ej: No enciende, pantalla negra, carga lenta..."></textarea>

        <label>Servicios / Posibles diagnósticos (elige)</label>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-top:8px">
          <!-- dynamically generated checkboxes -->
          <label><input type="checkbox" class="svc" value="Reconexión flex|150" /> Reconexión flex ($150)</label>
          <label><input type="checkbox" class="svc" value="Limpieza conectores|50" /> Limpieza conectores ($50)</label>
          <label><input type="checkbox" class="svc" value="Cambio display|250" /> Cambio display ($250)</label>
          <label><input type="checkbox" class="svc" value="Cambio batería|180" /> Cambio batería ($180)</label>
          <label><input type="checkbox" class="svc" value="Diagnóstico extendido|100" /> Diagnóstico extendido ($100)</label>
        </div>

        <label>Notas del técnico</label>
        <textarea id="notasInput" placeholder="Notas: ej. cliente pide entrega urgente, entregar a Dana..."></textarea>

        <div class="row" style="margin-top:12px; align-items:center">
          <div style="flex:1">
            <label>Estimado mínimo (auto)</label>
            <input id="estimadoInput" type="text" readonly />
          </div>
          <div style="width:120px">
            <label>Anticipo</label>
            <input id="anticipoInput" type="text" placeholder="$0.00" />
          </div>
        </div>

        <div style="display:flex; gap:8px; margin-top:14px">
          <button type="button" onclick="generarFolioManual()">Regenerar Folio</button>
          <button type="button" onclick="generarTicketPreview()" class="btn-ghost">Actualizar vista</button>
          <button type="button" onclick="generarEstimadoPDF()">Generar Estimado (PDF)</button>
        </div>

        <div class="small" style="margin-top:8px">Consejo: el folio debe quedar igual en el estimado y recibo final.</div>
      </form>

      <!-- Preview / Ticket -->
      <div class="preview">
        <div style="text-align:center; margin-bottom:8px">
          <strong>Vista previa del ticket</strong>
        </div>
        <div id="ticket" class="ticket">
BIO-US / TechnoFix
Servicio por: Oscar
Folio: <span id="t_folio"></span>
Fecha: <span id="t_fecha"></span>  Hora: <span id="t_hora"></span>
----------------------------------------
Cliente: <span id="t_cliente"></span>
Contacto: <span id="t_contacto"></span>
Dispositivo: <span id="t_tipo"></span>
Modelo: <span id="t_modelo"></span>
Origen del daño: <span id="t_origen"></span>
----------------------------------------
Problema: <span id="t_problema"></span>

Servicios / Diagnóstico:
<span id="t_servicios"></span>

Subtotal: $<span id="t_subtotal">0.00</span>
Anticipo: $<span id="t_anticipo">0.00</span>
TOTAL: $<span id="t_total">0.00</span>
----------------------------------------
Garantía mano de obra: 15 días.
No cubre humedad ni golpes adicionales.

Observaciones:
<span id="t_notas"></span>

Firma: ____________________
        </div>

        <div class="controls">
          <button onclick="descargarTicketPDF()">Descargar Recibo (PDF)</button>
          <button class="btn-ghost" onclick="limpiarForm()">Limpiar</button>
        </div>
        <div class="small" style="margin-top:8px">QR / Verificación (opcional): <input type="checkbox" id="qrToggle" onchange="toggleQR()" /></div>
        <div id="qrcodeArea" style="text-align:center; margin-top:8px"></div>
      </div>
    </div>
  </div>

<script>
// --- Data: catálogo básico (puedes editar) ---
const modelosPorMarca = {
  'iPhone': ['A1522 (iPhone 6 Plus)', 'iPhone 6', 'iPhone X', 'iPhone SE'],
  'Samsung': ['A04s','Galaxy S9','Galaxy S21','Otro'],
  'Oppo': ['A16','A57','Otro'],
  'Xiaomi': ['Redmi 9','Note 10','Otro'],
  'Otro': ['Especificar...']
};

// Inicializa modelos
function rellenarModelos(){
  const marca = document.getElementById('marcaInput').value;
  const sel = document.getElementById('modeloInput');
  sel.innerHTML = '';
  (modelosPorMarca[marca] || ['Otro']).forEach(m => {
    const opt = document.createElement('option'); opt.value = m; opt.textContent = m; sel.appendChild(opt);
  });
}
rellenarModelos();

// Folio automático (8 dígitos) --- usa modelo código + fecha/hora
function generarFolio(){
  const modelo = (document.getElementById('modeloInput').value || '0000').replace(/[^0-9]/g,'');
  const now = new Date();
  const y = now.getFullYear().toString().slice(2);
  const m = (now.getMonth()+1).toString().padStart(2,'0');
  const d = now.getDate().toString().padStart(2,'0');
  const mm = now.getMinutes().toString().padStart(2,'0');
  const ss = now.getSeconds().toString().padStart(2,'0');
  const base = (modelo || '1522') + y + m + d + mm + ss;
  return base.slice(-8);
}

function generarFolioManual(){
  const code = generarFolio();
  document.getElementById('folioInput').value = code;
  actualizarVistaTicket();
}

// Auto-setup folio & fecha on load
window.addEventListener('load', ()=>{
  document.getElementById('folioInput').value = generarFolio();
  const hoy = new Date().toISOString().slice(0,10);
  document.getElementById('fechaInput').value = hoy;
  const now = new Date();
  document.getElementById('horaInput').value = now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0');
  // attach input listeners
  const ids = ['clienteInput','contactoInput','tipoInput','modeloInput','fechaInput','horaInput','origenInput','problemaInput','notasInput','anticipoInput'];
  ids.forEach(id=>document.getElementById(id).addEventListener('input', actualizarVistaTicket));
  // service checkboxes
  document.querySelectorAll('.svc').forEach(ch=>ch.addEventListener('change', actualizarVistaTicket));
  // initial update
  actualizarVistaTicket();
});

function getSelectedServices(){
  const nodes = Array.from(document.querySelectorAll('.svc'));
  return nodes.filter(n=>n.checked).map(n=>{
    const [name,price] = n.value.split('|');
    return {name, price: Number(price)};
  });
}

function actualizarVistaTicket(){
  document.getElementById('t_folio').textContent = document.getElementById('folioInput').value || generarFolio();
  document.getElementById('t_cliente').textContent = document.getElementById('clienteInput').value || '---';
  document.getElementById('t_contacto').textContent = document.getElementById('contactoInput').value || '---';
  document.getElementById('t_tipo').textContent = document.getElementById('tipoInput').value;
  document.getElementById('t_modelo').textContent = document.getElementById('modeloInput').value;
  document.getElementById('t_fecha').textContent = document.getElementById('fechaInput').value;
  document.getElementById('t_hora').textContent = document.getElementById('horaInput').value;
  document.getElementById('t_origen').textContent = document.getElementById('origenInput').value;
  document.getElementById('t_problema').textContent = document.getElementById('problemaInput').value || '---';
  document.getElementById('t_notas').textContent = document.getElementById('notasInput').value || '---';

  // servicios
  const servicios = getSelectedServices();
  const serviciosStr = servicios.map(s=>`• ${s.name} — $${s.price.toFixed(2)}`).join('\n');
  document.getElementById('t_servicios').textContent = serviciosStr || 'Sin servicios seleccionados';

  const subtotal = servicios.reduce((s,i)=>s+i.price,0);
  document.getElementById('t_subtotal').textContent = subtotal.toFixed(2);
  const anticipo = parseFloat((document.getElementById('anticipoInput').value || '0').replace(/[^0-9.-]+/g,'')) || 0;
  document.getElementById('t_anticipo').textContent = anticipo.toFixed(2);
  const total = subtotal - anticipo;
  document.getElementById('t_total').textContent = total.toFixed(2);

  // estimadoInput
  document.getElementById('estimadoInput').value = '$' + subtotal.toFixed(2);
}

function generarTicketPreview(){ actualizarVistaTicket(); alert('Vista actualizada. Revisa la columna de la derecha.'); }

function descargarTicketPDF(){
  actualizarVistaTicket();
  const ticket = document.getElementById('ticket');
  const opt = { margin:0.2, filename: `${document.getElementById('folioInput').value || 'ticket'}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'a4',orientation:'portrait'}};
  html2pdf().set(opt).from(ticket).save();
}

function generarEstimadoPDF(){
  actualizarVistaTicket();
  // same PDF but add header "Estimado"
  const ticket = document.getElementById('ticket');
  const clone = ticket.cloneNode(true);
  // prepend Estimado note
  const div = document.createElement('div'); div.style.fontFamily='monospace'; div.style.marginBottom='6px'; div.textContent='*** ESTIMADO PREVIO - NO ES FACTURA ***';
  clone.insertBefore(div, clone.firstChild);
  const opt = { margin:0.2, filename: `${document.getElementById('folioInput').value || 'estimado'}-estimado.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in',format:'a4',orientation:'portrait'}};
  html2pdf().set(opt).from(clone).save();
}

function limpiarForm(){
  document.getElementById('serviceForm').reset();
  rellenarModelos();
  document.getElementById('folioInput').value = generarFolio();
  const hoy = new Date().toISOString().slice(0,10);
  document.getElementById('fechaInput').value = hoy;
  actualizarVistaTicket();
}

// QR toggle (uses Google Charts API if online)
function toggleQR(){
  const on = document.getElementById('qrToggle').checked;
  const area = document.getElementById('qrcodeArea'); area.innerHTML='';
  if(!on) return;
  const folio = document.getElementById('folioInput').value;
  const total = document.getElementById('t_total').textContent;
  const payload = encodeURIComponent(`FOLIO:${folio}|TOTAL:${total}|SERV:${document.getElementById('t_servicios').textContent}`);
  const src = `https://chart.googleapis.com/chart?cht=qr&chs=150x150&chl=${payload}`;
  const img = document.createElement('img'); img.src = src; img.alt='QR'; img.style.width='120px'; area.appendChild(img);
}

</script>
</body>
</html>
